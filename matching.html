<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Words - VocabLab</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav>
                <a href="index.html" class="logo">
                    <span class="logo-text">VocabLab</span>
                </a>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="vocabulary.html" class="nav-link">Vocabulary</a>
                </div>
            </nav>
        </header>

        <main>
            <div class="game-header">
                <h1>Match the Words</h1>
                <p>Click a word, then click its matching definition</p>
                <div class="game-stats">
                    <span>Score: <span id="score">0</span></span>
                    <span>Matches: <span id="matches">0</span>/<span id="total">6</span></span>
                </div>
            </div>

            <div id="matching-game">
                <div class="matching-grid">
                    <div class="column" id="words-column">
                        <h3>Words üìù</h3>
                        <div class="cards-container" id="words-container"></div>
                    </div>

                    <div class="column" id="definitions-column">
                        <h3>Definitions üìñ</h3>
                        <div class="cards-container" id="definitions-container"></div>
                    </div>
                </div>
            </div>

            <div id="result-popup" class="popup hidden">
                <div class="popup-content">
                    <span class="popup-emoji"></span>
                    <h2 class="popup-title"></h2>
                    <p class="popup-message"></p>
                    <button class="btn btn-primary" onclick="closePopup()">Continue</button>
                </div>
            </div>

            <div id="complete-popup" class="popup hidden">
                <div class="popup-content celebration">
                    <h2>üéâ Amazing! üéâ</h2>
                    <p>You matched all the words!</p>
                    <div class="final-score">
                        Final Score: <span id="final-score">0</span>
                    </div>
                    <div class="popup-buttons">
                        <a href="#" id="play-again-btn" class="btn btn-primary">Play Again</a>
                        <a href="index.html" class="btn btn-secondary">Home</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 VocabLab - Interactive ESL Vocabulary Learning</p>
            <p class="small">Engaging games and activities for all levels</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Progress Tracker -->
    <script src="js/progress-tracker.js"></script>

    <!-- UI Components -->
    <script src="js/ui-components.js"></script>

    <!-- Game Instructions -->
    <script src="js/game-instructions.js"></script>

    <script src="js/vocabulary.js"></script>
    <script>
        // Add How to Play button
        addHowToPlayButton('matching');

        // Show tip when game starts
        setTimeout(() => showContextualTip('matching', 'start'), 2000);

        let selectedWord = null;
        let selectedDefinition = null;
        let score = 0;
        let matches = 0;
        let totalMatches = 6;
        let currentDifficulty = 'all';
        let gameWords = {};

        document.addEventListener('DOMContentLoaded', function() {
            currentDifficulty = getDifficultyFromURL();
            initializeGame();
        });

        function initializeGame() {
            const allWords = getWordsByDifficulty(currentDifficulty);
            const selectedWordList = getRandomWords(allWords, 6);
            
            totalMatches = selectedWordList.length;
            document.getElementById('total').textContent = totalMatches;

            gameWords = {};
            selectedWordList.forEach(word => {
                gameWords[word] = allWords[word];
            });

            // Create word cards
            const wordsContainer = document.getElementById('words-container');
            wordsContainer.innerHTML = '';
            selectedWordList.forEach(word => {
                const card = createWordCard(word, gameWords[word]);
                wordsContainer.appendChild(card);
            });

            // Create definition cards (shuffled)
            const definitionsContainer = document.getElementById('definitions-container');
            definitionsContainer.innerHTML = '';
            const shuffledWords = shuffleArray(selectedWordList);
            shuffledWords.forEach(word => {
                const card = createDefinitionCard(word, gameWords[word]);
                definitionsContainer.appendChild(card);
            });

            // Update play again button
            document.getElementById('play-again-btn').href = `matching.html?difficulty=${currentDifficulty}`;
        }

        function createWordCard(word, data) {
            const card = document.createElement('div');
            card.className = 'match-card word-card';
            card.dataset.word = word;
            card.innerHTML = `
                <span class="card-emoji">${data.emoji}</span>
                <span class="card-text">${word}</span>
            `;
            card.addEventListener('click', () => selectCard(card, 'word'));
            return card;
        }

        function createDefinitionCard(word, data) {
            const card = document.createElement('div');
            card.className = 'match-card definition-card';
            card.dataset.word = word;
            card.innerHTML = `
                <span class="card-text">${data.definition}</span>
            `;
            card.addEventListener('click', () => selectCard(card, 'definition'));
            return card;
        }

        function selectCard(card, type) {
            if (card.classList.contains('matched')) return;

            if (type === 'word') {
                if (selectedWord) {
                    selectedWord.classList.remove('selected');
                }
                selectedWord = card;
                card.classList.add('selected');
            } else {
                if (selectedDefinition) {
                    selectedDefinition.classList.remove('selected');
                }
                selectedDefinition = card;
                card.classList.add('selected');
            }

            if (selectedWord && selectedDefinition) {
                checkMatch();
            }
        }

        function checkMatch() {
            const word = selectedWord.dataset.word;
            const definition = selectedDefinition.dataset.word;

            if (word === definition) {
                selectedWord.classList.add('matched');
                selectedDefinition.classList.add('matched');
                selectedWord.classList.remove('selected');
                selectedDefinition.classList.remove('selected');
                
                score += 10;
                matches++;
                
                updateStats();
                showResult(true, word);
                
                if (matches === totalMatches) {
                    setTimeout(showComplete, 1000);
                }
            } else {
                selectedWord.classList.add('wrong');
                selectedDefinition.classList.add('wrong');
                
                setTimeout(() => {
                    selectedWord.classList.remove('wrong', 'selected');
                    selectedDefinition.classList.remove('wrong', 'selected');
                }, 800);
                
                showResult(false, word);
            }
            
            selectedWord = null;
            selectedDefinition = null;
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('matches').textContent = matches;
        }

        function showResult(correct, word) {
            const popup = document.getElementById('result-popup');
            const emoji = popup.querySelector('.popup-emoji');
            const title = popup.querySelector('.popup-title');
            const message = popup.querySelector('.popup-message');

            if (correct) {
                emoji.textContent = gameWords[word].emoji;
                title.textContent = '‚úÖ Correct!';
                message.textContent = `"${word}" - ${gameWords[word].hint}`;
                popup.classList.add('success');
            } else {
                emoji.textContent = '‚ùå';
                title.textContent = 'Try Again!';
                message.textContent = "That's not the right match. Keep trying!";
                popup.classList.remove('success');
            }

            popup.classList.remove('hidden');
            setTimeout(closePopup, 2000);
        }

        function closePopup() {
            document.getElementById('result-popup').classList.add('hidden');
        }

        function showComplete() {
            const popup = document.getElementById('complete-popup');
            document.getElementById('final-score').textContent = score;
            popup.classList.remove('hidden');

            // Save progress if student is logged in
            const params = VocabLabProgress.getGameParams();
            VocabLabProgress.saveProgress({
                game: 'Match Words',
                theme: params.theme,
                difficulty: params.difficulty,
                score: score,
                correctAnswers: matches,
                totalQuestions: totalMatches
            });
        }
    </script>
</body>
</html>
