<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Challenge - VocabLab</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav>
                <a href="index.html" class="logo">
                    <span class="emoji">üß™</span>
                    <span>VocabLab</span>
                </a>
                <div class="nav-links">
                    <a href="index.html">üè† Home</a>
                    <a href="vocabulary.html">üìö Words</a>
                </div>
            </nav>
        </header>

        <main>
            <div class="game-header">
                <h1>‚ö° Speed Challenge</h1>
                <p>Answer as many questions as you can before time runs out!</p>
                <div class="game-stats">
                    <span>Score: <span id="score">0</span></span>
                    <span>Time: <span id="timer">60</span>s</span>
                </div>
            </div>

            <div id="speed-game">
                <div class="speed-display">
                    <div class="speed-progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>

                    <div class="speed-question">
                        <div class="question-emoji" id="question-emoji">‚ö°</div>
                        <div class="question-text" id="question-text">Click Start to begin!</div>
                    </div>

                    <div class="speed-choices" id="speed-choices">
                        <!-- Choices will be inserted here -->
                    </div>

                    <div class="speed-feedback" id="speed-feedback"></div>

                    <button class="btn btn-primary btn-large" id="start-btn">Start Challenge!</button>
                </div>

                <!-- Leaderboard -->
                <div class="leaderboard" id="leaderboard">
                    <h3>üèÜ Top Scores</h3>
                    <div id="leaderboard-list" class="leaderboard-list">
                        <!-- Leaderboard entries will be inserted here -->
                    </div>
                </div>
            </div>

            <div id="complete-popup" class="popup hidden">
                <div class="popup-content celebration">
                    <h2>‚ö° Time's Up! ‚ö°</h2>
                    <p>Great job on the speed challenge!</p>
                    <div class="final-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="final-score">0</div>
                            <div class="stat-label">Correct Answers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-answered">0</div>
                            <div class="stat-label">Total Answered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                    <div class="popup-buttons">
                        <a href="#" id="play-again-btn" class="btn btn-primary">Play Again</a>
                        <a href="index.html" class="btn btn-secondary">Home</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>üß™ VocabLab - Learn English with Fun!</p>
            <p class="small">Interactive ESL Vocabulary Games</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Progress Tracker -->
    <script src="js/progress-tracker.js"></script>

    <!-- UI Components -->
    <script src="js/ui-components.js"></script>

    <!-- Game Instructions -->
    <script src="js/game-instructions.js"></script>

    <!-- Utils -->
    <script src="js/utils.js"></script>

    <script src="js/vocabulary.js"></script>
    <script>
        let score = 0;
        let totalAnswered = 0;
        let timeRemaining = 60;
        let timerInterval = null;
        let gameActive = false;
        let currentQuestion = null;
        let allQuestions = [];

        // Get URL parameters
        const difficulty = getDifficultyFromURL();
        const theme = getThemeFromURL();

        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof VocabLabUtils !== 'undefined') {
                VocabLabUtils.addFullScreenButton();
                VocabLabUtils.initMobileNavigation();
                VocabLabUtils.optimizeTouchTargets();
                VocabLabUtils.handleError();
            }

            // Add How to Play button
            if (typeof addHowToPlayButton !== 'undefined') {
                addHowToPlayButton('speed');
            }

            // Show initial tip
            setTimeout(() => {
                if (typeof showContextualTip !== 'undefined') {
                    showContextualTip('speed', 'start');
                }
            }, 1000);
        });

        // Initialize game
        function initGame() {
            const words = getWordsByDifficulty(difficulty);
            const wordList = Object.keys(words);

            allQuestions = wordList.map(word => ({
                word: word,
                definition: words[word].definition,
                hint: words[word].hint,
                emoji: words[word].emoji
            }));

            allQuestions = shuffleArray(allQuestions);
        }

        // Start game
        document.getElementById('start-btn').addEventListener('click', function() {
            this.style.display = 'none';
            gameActive = true;
            startTimer();
            loadNextQuestion();
        });

        // Start timer
        function startTimer() {
            updateProgressBar();
            timerInterval = setInterval(function() {
                timeRemaining--;
                document.getElementById('timer').textContent = timeRemaining;
                updateProgressBar();

                if (timeRemaining <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // Update progress bar
        function updateProgressBar() {
            const percentage = (timeRemaining / 60) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';

            // Change color based on time remaining
            const bar = document.getElementById('progress-bar');
            if (timeRemaining > 30) {
                bar.style.background = 'var(--success)';
            } else if (timeRemaining > 10) {
                bar.style.background = 'var(--warning)';
            } else {
                bar.style.background = 'var(--danger)';
            }
        }

        // Load next question
        function loadNextQuestion() {
            if (!gameActive || allQuestions.length === 0) {
                endGame();
                return;
            }

            currentQuestion = allQuestions.shift();

            document.getElementById('question-emoji').textContent = currentQuestion.emoji;
            document.getElementById('question-text').textContent = currentQuestion.definition;

            generateChoices();
            document.getElementById('speed-feedback').textContent = '';
        }

        // Generate choices
        function generateChoices() {
            const allWords = Object.keys(getCurrentThemeWords());
            const choices = [currentQuestion.word];

            // Add 3 random wrong answers
            while (choices.length < 4) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                if (!choices.includes(randomWord)) {
                    choices.push(randomWord);
                }
            }

            const shuffled = shuffleArray(choices);

            const choicesDiv = document.getElementById('speed-choices');
            choicesDiv.innerHTML = '';

            shuffled.forEach(word => {
                const button = document.createElement('button');
                button.className = 'speed-choice-btn';
                button.textContent = word;
                button.onclick = () => checkAnswer(word);
                choicesDiv.appendChild(button);
            });
        }

        // Check answer
        function checkAnswer(selectedWord) {
            if (!gameActive) return;

            totalAnswered++;
            const feedback = document.getElementById('speed-feedback');

            if (selectedWord === currentQuestion.word) {
                score++;
                document.getElementById('score').textContent = score;
                feedback.textContent = '‚úÖ Correct!';
                feedback.style.color = 'var(--success)';
            } else {
                feedback.textContent = '‚ùå Wrong! It was "' + currentQuestion.word + '"';
                feedback.style.color = 'var(--danger)';
            }

            // Load next question after short delay
            setTimeout(loadNextQuestion, 800);
        }

        // End game
        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);

            const accuracy = totalAnswered > 0 ? Math.round((score / totalAnswered) * 100) : 0;

            document.getElementById('final-score').textContent = score;
            document.getElementById('total-answered').textContent = totalAnswered;
            document.getElementById('accuracy').textContent = accuracy + '%';

            document.getElementById('complete-popup').classList.remove('hidden');

            // Save to leaderboard
            saveToLeaderboard(score, accuracy);
            displayLeaderboard();

            // Save progress if student is logged in
            const params = VocabLabProgress.getGameParams();
            VocabLabProgress.saveProgress({
                game: 'Speed Challenge',
                theme: params.theme,
                difficulty: params.difficulty,
                score: accuracy,
                correctAnswers: score,
                totalQuestions: totalAnswered,
                timeSpent: 60 - timeRemaining
            });
        }

        // Leaderboard functions
        function getLeaderboardKey() {
            return `vocablab_speed_leaderboard_${theme}_${difficulty}`;
        }

        function saveToLeaderboard(score, accuracy) {
            const key = getLeaderboardKey();
            let leaderboard = JSON.parse(localStorage.getItem(key) || '[]');

            const entry = {
                score: score,
                accuracy: accuracy,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };

            leaderboard.push(entry);
            leaderboard.sort((a, b) => b.score - a.score || b.accuracy - a.accuracy);
            leaderboard = leaderboard.slice(0, 10); // Keep top 10

            localStorage.setItem(key, JSON.stringify(leaderboard));
        }

        function displayLeaderboard() {
            const key = getLeaderboardKey();
            const leaderboard = JSON.parse(localStorage.getItem(key) || '[]');
            const listDiv = document.getElementById('leaderboard-list');

            if (leaderboard.length === 0) {
                listDiv.innerHTML = '<p class="no-scores">No scores yet. Be the first!</p>';
                return;
            }

            listDiv.innerHTML = leaderboard.map((entry, index) => {
                const date = new Date(entry.date);
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                return `
                    <div class="leaderboard-entry ${index < 3 ? 'top-three' : ''}">
                        <span class="rank">${medal}</span>
                        <span class="score-info">
                            <strong>${entry.score} points</strong>
                            <small>${entry.accuracy}% accuracy</small>
                        </span>
                        <span class="date">${date.toLocaleDateString()}</span>
                    </div>
                `;
            }).join('');
        }

        // Play again
        document.getElementById('play-again-btn').addEventListener('click', function(e) {
            e.preventDefault();
            location.reload();
        });

        // Initialize
        initGame();
        displayLeaderboard();
    </script>
</body>
</html>
