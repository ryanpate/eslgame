<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Quiz - VocabLab</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav>
                <a href="index.html" class="logo">
                    <span class="emoji">üß™</span>
                    <span>VocabLab</span>
                </a>
                <div class="nav-links">
                    <a href="index.html">üè† Home</a>
                    <a href="vocabulary.html">üìö Words</a>
                </div>
            </nav>
        </header>

        <main>
            <div class="game-header">
                <h1>üé¥ Flashcard Quiz</h1>
                <p>Read the definition and choose the correct word!</p>
                <div class="game-stats">
                    <span>Score: <span id="score">0</span></span>
                    <span>Question: <span id="current">1</span>/<span id="total">0</span></span>
                </div>
            </div>

            <div id="flashcard-game">
                <div class="flashcard-display">
                    <div class="flashcard-emoji" id="flashcard-emoji">üé¥</div>
                    <div class="flashcard-definition" id="flashcard-definition">Loading...</div>

                    <div class="choices-grid" id="choices-grid">
                        <!-- Choices will be inserted here -->
                    </div>

                    <div class="help-section">
                        <button class="btn btn-secondary" id="hint-btn">üí° Show Hint</button>
                    </div>

                    <div id="extra-hint" class="extra-hint hidden"></div>
                </div>
            </div>

            <div id="result-popup" class="popup hidden">
                <div class="popup-content">
                    <span class="popup-emoji"></span>
                    <h2 class="popup-title"></h2>
                    <p class="popup-message"></p>
                    <div class="popup-buttons">
                        <button class="btn btn-primary" onclick="nextQuestion()">Next Question ‚û°Ô∏è</button>
                    </div>
                </div>
            </div>

            <div id="complete-popup" class="popup hidden">
                <div class="popup-content celebration">
                    <h2>üéâ Quiz Complete! üéâ</h2>
                    <p>You finished all the questions!</p>
                    <div class="final-score">
                        Final Score: <span id="final-score">0</span> / <span id="final-total">0</span>
                    </div>
                    <div class="popup-buttons">
                        <a href="#" id="play-again-btn" class="btn btn-primary">Play Again</a>
                        <a href="index.html" class="btn btn-secondary">Home</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>üß™ VocabLab - Learn English with Fun!</p>
            <p class="small">Interactive ESL Vocabulary Games</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Progress Tracker -->
    <script src="js/progress-tracker.js"></script>

    <!-- UI Components -->
    <script src="js/ui-components.js"></script>

    <!-- Game Instructions -->
    <script src="js/game-instructions.js"></script>

    <!-- Utils -->
    <script src="js/utils.js"></script>

    <script src="js/vocabulary.js"></script>
    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let correctAnswer = '';
        let canSwipe = false;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const difficulty = getDifficultyFromURL();
        const theme = getThemeFromURL();

        // Initialize game
        function initGame() {
            const words = getWordsByDifficulty(difficulty);
            const wordList = getRandomWords(words, 10); // 10 questions per game

            questions = wordList.map(word => ({
                word: word,
                definition: words[word].definition,
                hint: words[word].hint,
                emoji: words[word].emoji
            }));

            document.getElementById('total').textContent = questions.length;
            loadQuestion();

            // Initialize mobile features
            if (typeof VocabLabUtils !== 'undefined') {
                // Add swipe gestures for mobile
                const flashcardDisplay = document.querySelector('.flashcard-display');
                VocabLabUtils.addSwipeGesture(flashcardDisplay, {
                    onSwipeLeft: () => {
                        if (canSwipe) {
                            nextQuestion();
                        }
                    }
                });

                // Add swipe indicator
                if (VocabLabUtils.isMobileDevice()) {
                    const swipeIndicator = document.createElement('div');
                    swipeIndicator.className = 'swipe-indicator show';
                    swipeIndicator.textContent = 'Swipe left for next question';
                    flashcardDisplay.appendChild(swipeIndicator);

                    // Hide after 3 seconds
                    setTimeout(() => {
                        swipeIndicator.classList.remove('show');
                    }, 3000);
                }

                // Add fullscreen button
                VocabLabUtils.addFullScreenButton();
            }

            // Add How to Play button
            if (typeof addHowToPlayButton !== 'undefined') {
                addHowToPlayButton('flashcard');
            }

            // Show initial tip
            setTimeout(() => {
                if (typeof showContextualTip !== 'undefined') {
                    showContextualTip('flashcard', 'start');
                }
            }, 1000);
        }

        // Load current question
        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showCompletePopup();
                return;
            }

            const question = questions[currentQuestionIndex];
            correctAnswer = question.word;
            canSwipe = false; // Disable swipe until answer is selected

            // Update UI
            document.getElementById('current').textContent = currentQuestionIndex + 1;
            document.getElementById('flashcard-emoji').textContent = question.emoji;
            document.getElementById('flashcard-definition').textContent = question.definition;
            document.getElementById('extra-hint').classList.add('hidden');

            // Generate choices
            generateChoices(question);
        }

        // Generate multiple choice options
        function generateChoices(question) {
            const allWords = Object.keys(getCurrentThemeWords());
            const choices = [question.word];

            // Add 3 random wrong answers
            while (choices.length < 4) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                if (!choices.includes(randomWord)) {
                    choices.push(randomWord);
                }
            }

            // Shuffle choices
            const shuffled = shuffleArray(choices);

            // Create choice buttons
            const choicesGrid = document.getElementById('choices-grid');
            choicesGrid.innerHTML = '';

            shuffled.forEach(word => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = word;
                button.onclick = () => checkAnswer(word, button);
                choicesGrid.appendChild(button);
            });
        }

        // Check answer
        function checkAnswer(selectedWord, button) {
            const allButtons = document.querySelectorAll('.choice-btn');
            allButtons.forEach(btn => btn.disabled = true);

            if (selectedWord === correctAnswer) {
                score++;
                document.getElementById('score').textContent = score;
                button.classList.add('correct');
                showResultPopup(true);
            } else {
                button.classList.add('incorrect');
                // Highlight correct answer
                allButtons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                showResultPopup(false);
            }
        }

        // Show result popup
        function showResultPopup(isCorrect) {
            const popup = document.getElementById('result-popup');
            const emoji = popup.querySelector('.popup-emoji');
            const title = popup.querySelector('.popup-title');
            const message = popup.querySelector('.popup-message');

            if (isCorrect) {
                emoji.textContent = 'üéâ';
                title.textContent = 'Correct!';
                message.textContent = `Great job! "${correctAnswer}" is the right answer!`;
            } else {
                emoji.textContent = 'üòï';
                title.textContent = 'Not Quite';
                message.textContent = `The correct answer was "${correctAnswer}". Keep trying!`;
            }

            popup.classList.remove('hidden');
            canSwipe = true; // Enable swipe after answer is shown
        }

        // Next question
        function nextQuestion() {
            document.getElementById('result-popup').classList.add('hidden');
            currentQuestionIndex++;
            loadQuestion();
        }

        // Show hint
        document.getElementById('hint-btn').addEventListener('click', function() {
            const question = questions[currentQuestionIndex];
            const hintDiv = document.getElementById('extra-hint');
            hintDiv.textContent = 'üí° ' + question.hint;
            hintDiv.classList.remove('hidden');
        });

        // Show complete popup
        function showCompletePopup() {
            const popup = document.getElementById('complete-popup');
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-total').textContent = questions.length;
            popup.classList.remove('hidden');

            // Save progress if student is logged in
            const params = VocabLabProgress.getGameParams();
            const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
            VocabLabProgress.saveProgress({
                game: 'Flashcard Quiz',
                theme: params.theme,
                difficulty: params.difficulty,
                score: percentage,
                correctAnswers: score,
                totalQuestions: questions.length
            });
        }

        // Play again button
        document.getElementById('play-again-btn').addEventListener('click', function(e) {
            e.preventDefault();
            location.reload();
        });

        // Start the game
        initGame();
    </script>
</body>
</html>
