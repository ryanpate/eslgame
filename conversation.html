<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Builder - VocabLab</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav>
                <a href="index.html" class="logo">
                    <span class="emoji">üß™</span>
                    <span>VocabLab</span>
                </a>
                <div class="nav-links">
                    <a href="index.html">üè† Home</a>
                    <a href="vocabulary.html">üìö Words</a>
                </div>
            </nav>
        </header>

        <main>
            <div class="game-header">
                <h1>üí¨ Conversation Builder</h1>
                <p>Complete the sentence with the correct vocabulary word!</p>
                <div class="game-stats">
                    <span>Score: <span id="score">0</span></span>
                    <span>Sentence: <span id="current">1</span>/<span id="total">0</span></span>
                </div>
            </div>

            <div id="conversation-game">
                <div class="conversation-display">
                    <div class="conversation-emoji" id="conversation-emoji">üí¨</div>

                    <div class="sentence-container">
                        <div class="sentence-text" id="sentence-text">Loading...</div>
                    </div>

                    <div class="word-bank" id="word-bank">
                        <div class="word-bank-title">Choose the correct word:</div>
                        <div class="word-bank-words" id="word-bank-words">
                            <!-- Word options will be inserted here -->
                        </div>
                    </div>

                    <div class="help-section">
                        <button class="btn btn-secondary" id="hint-btn">üí° Show Hint</button>
                        <button class="btn btn-secondary" id="skip-btn">‚è≠Ô∏è Skip</button>
                    </div>

                    <div id="extra-hint" class="extra-hint hidden"></div>
                </div>
            </div>

            <div id="result-popup" class="popup hidden">
                <div class="popup-content">
                    <span class="popup-emoji"></span>
                    <h2 class="popup-title"></h2>
                    <p class="popup-message"></p>
                    <div class="popup-buttons">
                        <button class="btn btn-primary" onclick="nextSentence()">Next Sentence ‚û°Ô∏è</button>
                    </div>
                </div>
            </div>

            <div id="complete-popup" class="popup hidden">
                <div class="popup-content celebration">
                    <h2>üéâ All Done! üéâ</h2>
                    <p>You completed all the sentences!</p>
                    <div class="final-score">
                        Final Score: <span id="final-score">0</span> / <span id="final-total">0</span>
                    </div>
                    <div class="popup-buttons">
                        <a href="#" id="play-again-btn" class="btn btn-primary">Play Again</a>
                        <a href="index.html" class="btn btn-secondary">Home</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>üß™ VocabLab - Learn English with Fun!</p>
            <p class="small">Interactive ESL Vocabulary Games</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Progress Tracker -->
    <script src="js/progress-tracker.js"></script>

    <!-- UI Components -->
    <script src="js/ui-components.js"></script>

    <!-- Game Instructions -->
    <script src="js/game-instructions.js"></script>

    <!-- Utils -->
    <script src="js/utils.js"></script>

    <script src="js/vocabulary.js"></script>
    <script>
        let currentSentenceIndex = 0;
        let score = 0;
        let sentences = [];
        let correctAnswer = '';

        // Get URL parameters
        const difficulty = getDifficultyFromURL();
        const theme = getThemeFromURL();

        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof VocabLabUtils !== 'undefined') {
                VocabLabUtils.addFullScreenButton();
            }

            // Add How to Play button
            if (typeof addHowToPlayButton !== 'undefined') {
                addHowToPlayButton('conversation');
            }

            // Show initial tip
            setTimeout(() => {
                if (typeof showContextualTip !== 'undefined') {
                    showContextualTip('conversation', 'start');
                }
            }, 1000);
        });

        // Word-specific sentence templates by theme
        const sentencePatterns = {
            'daily-life': {
                'house': 'I live in a big ___ with my family.',
                'kitchen': 'We cook our meals in the ___.',
                'bedroom': 'I sleep in my ___ every night.',
                'door': 'Please close the ___ when you leave.',
                'window': 'Open the ___ to let in fresh air.',
                'chair': 'Sit down on this ___ and relax.',
                'table': 'We eat dinner at the ___ together.',
                'breakfast': 'I always eat ___ before school.',
                'lunch': 'What did you have for ___ today?',
                'dinner': 'We have ___ at 6 PM every evening.',
                'family': 'My ___ includes my parents and siblings.',
                'mother': 'My ___ takes care of us every day.',
                'father': 'My ___ goes to work in the morning.',
                'school': 'I go to ___ five days a week.',
                'book': 'I\'m reading an interesting ___ right now.',
                'pen': 'May I borrow your ___ to write?',
                'water': 'I drink eight glasses of ___ daily.',
                'bread': 'We buy fresh ___ from the bakery.',
                'milk': 'Pour some ___ into your cereal.',
                'friend': 'My best ___ lives next door.',
                'bathroom': 'I need to use the ___ before we leave.',
                'furniture': 'We bought new ___ for the living room.',
                'refrigerator': 'Put the milk back in the ___.',
                'grocery': 'I need to buy ___ at the store.',
                'shopping': 'I love going ___ on weekends.',
                'neighbor': 'Our ___ is very friendly and helpful.',
                'apartment': 'They rent a small ___ downtown.',
                'restaurant': 'Let\'s eat at that new ___ tonight.',
                'transportation': 'What ___ do you use to get to work?',
                'bicycle': 'I ride my ___ to school every day.',
                'cooking': 'I enjoy ___ dinner for my family.',
                'laundry': 'I need to do the ___ this weekend.',
                'homework': 'Don\'t forget to finish your ___ tonight.',
                'backpack': 'Pack your books in your ___.',
                'calendar': 'Check the ___ to see what day it is.',
                'schedule': 'What is your ___ for tomorrow?',
                'medicine': 'Take this ___ twice a day.',
                'exercise': 'I ___ at the gym three times a week.',
                'vacation': 'We\'re going on ___ next month.',
                'appliance': 'We need to buy a new kitchen ___.',
                'mortgage': 'They pay their ___ every month.',
                'utilities': 'Don\'t forget to pay the ___ bills.',
                'commute': 'My daily ___ takes about 30 minutes.',
                'ingredients': 'Mix all the ___ in a large bowl.',
                'nutrition': 'Good ___ is important for your health.',
                'budget': 'We need to stick to our monthly ___.',
                'expenses': 'Track all your ___ in this notebook.',
                'hygiene': 'Personal ___ is very important.',
                'curriculum': 'The school ___ includes math and science.',
                'assignment': 'The teacher gave us a difficult ___.',
                'semester': 'This ___ I\'m taking five classes.',
                'cafeteria': 'Let\'s meet in the ___ for lunch.',
                'pedestrian': 'Wait for the ___ signal before crossing.',
                'intersection': 'Turn left at the next ___.',
                'pharmacy': 'I need to pick up medicine at the ___.',
                'appointment': 'I have an ___ with the doctor tomorrow.',
                'maintenance': 'The building needs regular ___.',
                'organize': 'Let\'s ___ these files by date.',
                'responsibility': 'Taking care of pets is a big ___.'
            },
            'nature-animals': {
                'dog': 'My pet ___ loves to play fetch.',
                'cat': 'The ___ is sleeping on the couch.',
                'bird': 'I saw a beautiful ___ in the tree.',
                'fish': 'There are many ___ swimming in the pond.',
                'tree': 'We planted a new ___ in our yard.',
                'flower': 'This ___ smells wonderful.',
                'sun': 'The ___ is very bright today.',
                'rain': 'Don\'t forget your umbrella - it might ___.',
                'cloud': 'Look at that dark ___ in the sky.',
                'wind': 'The ___ is blowing very strongly.',
                'snow': 'It might ___ tomorrow morning.',
                'grass': 'The ___ needs to be cut this weekend.',
                'mountain': 'We climbed to the top of the ___.',
                'ocean': 'I love swimming in the ___.',
                'river': 'The ___ flows into the sea.',
                'beach': 'Let\'s go to the ___ this weekend.',
                'stone': 'He threw a ___ into the water.',
                'leaf': 'The ___ fell from the tree.',
                'butterfly': 'A colorful ___ landed on the flower.',
                'bee': 'The ___ is collecting pollen.',
                'forest': 'We went hiking in the ___.',
                'jungle': 'Many exotic animals live in the ___.',
                'desert': 'The ___ is very hot and dry.',
                'elephant': 'The ___ is the largest land animal.',
                'giraffe': 'The ___ has a very long neck.',
                'lion': 'The ___ is called the king of animals.',
                'tiger': 'The ___ has beautiful orange stripes.',
                'dolphin': 'The ___ is very intelligent.',
                'penguin': 'The ___ can swim but cannot fly.',
                'thunder': 'I heard loud ___ during the storm.',
                'lightning': 'The ___ lit up the dark sky.',
                'storm': 'The ___ lasted for several hours.',
                'rainbow': 'We saw a beautiful ___ after the rain.',
                'volcano': 'The ___ erupted last year.',
                'earthquake': 'The ___ shook the entire city.',
                'valley': 'The small town sits in a ___.',
                'waterfall': 'The ___ is 100 meters high.',
                'pond': 'Frogs live in the ___ near our house.',
                'stream': 'We crossed the small ___ on foot.',
                'creature': 'What kind of ___ is that?',
                'ecosystem': 'The rainforest has a complex ___.',
                'habitat': 'Polar bears\' natural ___ is the Arctic.',
                'extinction': 'Many species face ___ today.',
                'endangered': 'Tigers are an ___ species.',
                'biodiversity': 'The ___ in this area is amazing.',
                'photosynthesis': 'Plants use ___ to make food.',
                'predator': 'The ___ hunts for food at night.',
                'prey': 'The rabbit is ___ for many animals.',
                'camouflage': 'The lizard uses ___ to hide.',
                'migration': 'Bird ___ happens every autumn.',
                'hibernate': 'Bears ___ during the winter.',
                'nocturnal': 'Owls are ___ birds.',
                'pollination': 'Bees help with ___ of flowers.',
                'evaporation': 'Heat causes water ___.',
                'precipitation': '___ includes rain, snow, and hail.',
                'atmosphere': 'Earth\'s ___ protects us from the sun.',
                'conservation': 'Wildlife ___ is very important.',
                'deforestation': '___ is destroying many forests.',
                'climate': 'The ___ is changing around the world.',
                'metamorphosis': 'Butterflies undergo ___ as they grow.'
            },
            'technology': {
                'computer': 'I use my ___ for homework every day.',
                'phone': 'My ___ battery is running low.',
                'keyboard': 'I type on the ___ very quickly.',
                'mouse': 'Click the ___ to select that file.',
                'screen': 'The ___ on my laptop is very clear.',
                'internet': 'I need the ___ to do my research.',
                'email': 'Send me an ___ with the details.',
                'website': 'Check our school ___ for information.',
                'password': 'Don\'t share your ___ with anyone.',
                'camera': 'Use your ___ to take a picture.',
                'video': 'We watched a funny ___ online.',
                'music': 'I listen to ___ while studying.',
                'download': 'You need to ___ this app first.',
                'upload': 'Please ___ your homework to the website.',
                'app': 'Download this ___ on your phone.',
                'game': 'What ___ are you playing?',
                'message': 'I received your text ___.',
                'photo': 'That\'s a nice ___ of your family.',
                'click': 'Just ___ on this button.',
                'search': 'Let me ___ for that information online.',
                'software': 'We need to install new ___.',
                'hardware': 'The ___ in this computer is outdated.',
                'laptop': 'I carry my ___ to class every day.',
                'tablet': 'I read books on my ___.',
                'smartphone': 'My new ___ has many features.',
                'browser': 'Which web ___ do you prefer?',
                'social': 'I use ___ media to connect with friends.',
                'streaming': 'We watch movies on a ___ service.',
                'wifi': 'The ___ signal is very weak here.',
                'bluetooth': 'Connect your headphones via ___.',
                'backup': 'Always ___ your important files.',
                'update': 'Don\'t forget to ___ your apps regularly.',
                'virus': 'My computer has a ___!',
                'security': 'Online ___ is very important.',
                'profile': 'Update your social media ___.',
                'notification': 'I got a ___ from the app.',
                'settings': 'Check the ___ to change options.',
                'storage': 'My phone has 64GB of ___.',
                'battery': 'The ___ needs to be charged.',
                'charger': 'I forgot to bring my phone ___.',
                'algorithm': 'The app uses an ___ to recommend videos.',
                'artificial': '___ intelligence is changing technology.',
                'bandwidth': 'We need more ___ for faster internet.',
                'cloud': 'All my files are stored in the ___.',
                'database': 'The ___ stores customer information.',
                'encryption': '___ keeps your data safe.',
                'firewall': 'A ___ protects your network.',
                'interface': 'This app has a user-friendly ___.',
                'network': 'Connect to the school ___.',
                'processor': 'This computer has a fast ___.',
                'programming': 'I\'m learning ___ at school.',
                'server': 'The website ___ is down right now.',
                'virtual': '___ reality is amazing technology.',
                'malware': 'Protect your computer from ___.',
                'authenticate': 'You need to ___ your identity.',
                'broadband': 'We have ___ internet at home.',
                'cybersecurity': '___ experts protect our data.',
                'pixel': 'This image has millions of ___.',
                'resolution': 'The screen has high ___.',
                'cryptocurrency': '___ is a type of digital money.'
            }
        };

        // Initialize game
        function initGame() {
            const words = getWordsByDifficulty(difficulty);
            const wordList = getRandomWords(words, 8);
            const patterns = sentencePatterns[theme] || sentencePatterns['daily-life'];

            sentences = wordList.map(word => {
                // Use specific pattern if available, otherwise create generic one
                const sentence = patterns[word] || `This is related to ___.`;

                return {
                    word: word,
                    sentence: sentence,
                    definition: words[word].definition,
                    hint: words[word].hint,
                    emoji: words[word].emoji
                };
            });

            document.getElementById('total').textContent = sentences.length;
            loadSentence();
        }

        // Load current sentence
        function loadSentence() {
            if (currentSentenceIndex >= sentences.length) {
                showCompletePopup();
                return;
            }

            const sentence = sentences[currentSentenceIndex];
            correctAnswer = sentence.word;

            document.getElementById('current').textContent = currentSentenceIndex + 1;
            document.getElementById('conversation-emoji').textContent = sentence.emoji;

            // Display sentence with blank
            const sentenceWithBlank = sentence.sentence.replace('___', '____');
            document.getElementById('sentence-text').innerHTML = `"${sentenceWithBlank}"`;

            document.getElementById('extra-hint').classList.add('hidden');

            generateWordBank();
        }

        // Generate word bank options
        function generateWordBank() {
            const allWords = Object.keys(getCurrentThemeWords());
            const options = [correctAnswer];

            // Add 3 random wrong answers
            while (options.length < 4) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                if (!options.includes(randomWord)) {
                    options.push(randomWord);
                }
            }

            const shuffled = shuffleArray(options);

            const wordBankDiv = document.getElementById('word-bank-words');
            wordBankDiv.innerHTML = '';

            shuffled.forEach(word => {
                const button = document.createElement('button');
                button.className = 'word-bank-btn';
                button.textContent = word;
                button.onclick = () => checkAnswer(word, button);
                wordBankDiv.appendChild(button);
            });
        }

        // Check answer
        function checkAnswer(selectedWord, button) {
            const allButtons = document.querySelectorAll('.word-bank-btn');
            allButtons.forEach(btn => btn.disabled = true);

            if (selectedWord === correctAnswer) {
                score++;
                document.getElementById('score').textContent = score;
                button.classList.add('correct');

                // Show completed sentence
                const sentence = sentences[currentSentenceIndex];
                const completedSentence = sentence.sentence.replace('___', `<strong>${correctAnswer}</strong>`);
                document.getElementById('sentence-text').innerHTML = `"${completedSentence}"`;

                showResultPopup(true);
            } else {
                button.classList.add('incorrect');
                allButtons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                showResultPopup(false);
            }
        }

        // Show result popup
        function showResultPopup(isCorrect) {
            const popup = document.getElementById('result-popup');
            const emoji = popup.querySelector('.popup-emoji');
            const title = popup.querySelector('.popup-title');
            const message = popup.querySelector('.popup-message');

            if (isCorrect) {
                emoji.textContent = 'üéâ';
                title.textContent = 'Perfect!';
                message.textContent = `Great job! "${correctAnswer}" fits perfectly!`;
            } else {
                emoji.textContent = 'üòï';
                title.textContent = 'Not quite';
                message.textContent = `The correct word was "${correctAnswer}". Keep practicing!`;
            }

            popup.classList.remove('hidden');
        }

        // Next sentence
        function nextSentence() {
            document.getElementById('result-popup').classList.add('hidden');
            currentSentenceIndex++;
            loadSentence();
        }

        // Show hint
        document.getElementById('hint-btn').addEventListener('click', function() {
            const sentence = sentences[currentSentenceIndex];
            const hintDiv = document.getElementById('extra-hint');
            hintDiv.textContent = 'üí° Definition: ' + sentence.definition;
            hintDiv.classList.remove('hidden');
        });

        // Skip button
        document.getElementById('skip-btn').addEventListener('click', function() {
            currentSentenceIndex++;
            loadSentence();
        });

        // Show complete popup
        function showCompletePopup() {
            const popup = document.getElementById('complete-popup');
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-total').textContent = sentences.length;
            popup.classList.remove('hidden');

            // Save progress if student is logged in
            const params = VocabLabProgress.getGameParams();
            const percentage = sentences.length > 0 ? Math.round((score / sentences.length) * 100) : 0;
            VocabLabProgress.saveProgress({
                game: 'Conversation Builder',
                theme: params.theme,
                difficulty: params.difficulty,
                score: percentage,
                correctAnswers: score,
                totalQuestions: sentences.length
            });
        }

        // Play again
        document.getElementById('play-again-btn').addEventListener('click', function(e) {
            e.preventDefault();
            location.reload();
        });

        // Initialize
        initGame();
    </script>
</body>
</html>
